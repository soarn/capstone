{% extends "base.html" %} {% block title %}Admin Panel - Stock Trading System{% endblock %}
{% block content %}

<body data-user-pagination="{{ current_user.pagination }}" data-transaction-data-url="{{ url_for('admin.transaction_data') }}">

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Left-side navigation -->
    <nav id="admin-nav" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="#market-management">Market Management</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#stock-management">Stock Management</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#user-management">User Management</a>
          </li>
          </li class="nav-item">
            <a class="nav-link" href="#transaction-history">Transaction History</a>
          <li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <h1>Admin Dashboard</h1>
        <div id="market-status" class="text-muted">
          <h6>Market Status:</h6>
          <p class="d-flex justify-content-end">{{ market_status }}</p>
        </div>
      </div>

        <!-- Stock Market Management Section -->
        <section id="market-management" class="mb-5 p-3 bg-body border rounded">
          <h2 class="mb-4 text-primary border-bottom pb-2">Market Management</h2>
          <form method="POST" action="{{ url_for('admin.update_market') }}" novalidate>
            {{ update_market_form.hidden_tag() }}
            <input type="hidden" name="form_name" value="update-market">

            <!-- Market Open and Close Times -->
            <div class="form-group mb-3"> <!--  # TODO: #34 Use current time from db if available -->
              {{ update_market_form.open(class="form-control", required=True, type="time") }}
              {{ update_market_form.open.label }}
            </div>
            <div class="form-group mb-3">
              {{ update_market_form.close(class="form-control", required=True, type="time") }}
              {{ update_market_form.close.label }}
            </div>

            <!-- Days Selection -->
            <div class="form-group mb-3">
              {{ update_market_form.open_days.label }}
              {{ update_market_form.open_days(class="form-control", id="open-days", multiple=True) }}
            </div>

            <!-- Holiday Closure Toggle -->
            <div class="form-check mb-3">
              {{ update_market_form.close_on_holidays(class="form-check-input") }}
              {{ update_market_form.close_on_holidays.label }}
            </div>

            <div id="market-management-submit-section" class="mb-3">
              {{ update_market_form.submit(class="btn btn-primary mt-3") }}
            </div>
          </form>
        </section>
        
        <!-- <hr /> -->

        <!-- Stock Management Section -->
        <h1 class="mb-4 text-primary border-bottom pb-2">Stock Management</h1>
        <section id="stock-management" class="mb-5 p-3 bg-body border rounded">
          <!-- Update Stock Form -->
          <form method="POST" action="{{ url_for('admin.update_stock') }}" novalidate>
            {{ update_form.hidden_tag() }}
            <input type="hidden" name="form_name" value="update-stock">
            <h2 class="mb-4 text-primary border-bottom pb-2">Update Stocks</h2>
            <div class="form-group mb-3">
              {{ update_form.stock_id(class="form-select", required=True) }} {{
                update_form.stock_id.label }}
            </div>
            <div class="form-group mb-3">
              {{ update_form.new_price(class="form-control", required=True, step="0.01",
              placeholder="Enter new price") }} {{ update_form.new_price.label }}
            </div>
            <div class="form-check mb-3">
              {{ update_form.is_manual(class="form-check-input") }} {{
                update_form.is_manual.label }}
            </div>
            <div class="form-group mb-3">
              {{ update_form.fluctuation_multiplier(class="form-control", required=True,
              step="0.01", placeholder="Enter fluctuation multiplier") }} {{
                update_form.fluctuation_multiplier.label }}
            </div>
            <div id="update-submit-section" class="mb-3">
              {{ update_form.submit(class="btn btn-primary mt-3") }}
            </div>
          </form>

          <!-- Create Stock Form -->
          <form method="POST" action="{{ url_for('admin.create_stock') }}" novalidate>
            {{ add_form.hidden_tag() }}
            <input type="hidden" name="form_name" value="create-stock">
            <h2 class="mb-4 text-primary border-bottom pb-2">Create Stock</h2>
            <div class="form-group mb-3">
              {{ add_form.company(class="form-control", required=True, placeholder="Enter stock name") }} {{
                add_form.company.label }}
            </div>
            <div class="form-group mb-3">
              {{ add_form.symbol(class="form-control", required=True, placeholder="Enter stock symbol") }} {{
                add_form.symbol.label }}
            </div>
            <div class="form-group mb-3">
              {{ add_form.price(class="form-control", required=True, step="0.01", placeholder="Enter stock price") }} {{
                add_form.price.label }}
            </div>
            <div class="form-group mb-3">
              {{ add_form.quantity(class="form-control", required=True, placeholder="Enter stock quantity") }} {{
                add_form.quantity.label }}
            </div>
            <div id="create-submit-section" class="mb-3">
              {{ add_form.submit(class="btn btn-primary mt-3") }}
            </div>
          </form>

        </section>

      <!-- User Management Section -->
      <section id="user-management" class="mb-5 p-3 bg-body border rounded">
        <h2 class="mb-4 text-primary border-bottom pb-2">User Management</h2>
        <div class="table-responsive">
          <table class="table table-striped table-bordered mt-3">
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Balance</th>
                <th>Last Login</th>
              </tr>
            </thead>
            <tbody>
              {% for user in all_users %}
              <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.role }}</td>
                <td>{{ user.status }}</td>
                <td>${{ "{:,.2f}".format(user.balance) }}</td>
                <td id="user-management-last-login">{{ moment(user.last_login).format('LLL') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <hr />

      <section id="transaction-history" class="mb-5 p-3 bg-body border rounded">
        <h2 class="mb-4 text-primary border-bottom pb-2">Transaction History</h2>
        <div class="table-responsive">
          <table id="transactions-table" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Order Number</th>
                <th>Username</th>
                <th>Symbol</th>
                <th>Action</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for transaction, stock_symbol, username in transactions %}
              <tr>
                <td>{{ transaction.order_number }}</td>
                <td>{{ username }}</td>
                <td>{{ stock_symbol }}</td>
                <td>{{ transaction.type }}</td>
                <td>{{ transaction.quantity }}</td>
                <td>{{ transaction.price }}</td>
                <td>{{ transaction.amount }}</td>
                <td>{{ transaction.timestamp }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="{{ url_for('static', filename='js/bundles/admin.bundle.js') }}"></script>
{{ moment.include_moment() }}
{% endblock %}
